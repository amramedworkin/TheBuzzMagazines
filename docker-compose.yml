# Docker Compose for SuiteCRM 8.8.0
# LOCAL DEVELOPMENT with Azure Backend
#
# Prerequisites:
#   1. Run: ./scripts/azure-provision.sh (creates Azure resources)
#   2. Run: sudo ./scripts/azure-mount.sh (mounts Azure Files locally)
#   3. Run: docker compose up --build -d

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    platform: linux/amd64
    container_name: suitecrm-web
    restart: unless-stopped
    ports:
      - "80:80"
    environment:
      # Database configuration (Azure MySQL)
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT:-3306}
      - DATABASE_NAME=${DATABASE_NAME:-suitecrm}
      - DATABASE_USER=${DATABASE_USER:-suitecrm}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      # SSL settings (required for Azure MySQL)
      - DATABASE_SSL_ENABLED=${DATABASE_SSL_ENABLED:-true}
      - DATABASE_SSL_VERIFY=${DATABASE_SSL_VERIFY:-true}
      # SuiteCRM configuration
      - SUITECRM_SITE_URL=${SUITECRM_SITE_URL:-http://localhost}
      - SUITECRM_ADMIN_USER=${SUITECRM_ADMIN_USER:-admin}
      - SUITECRM_ADMIN_PASSWORD=${SUITECRM_ADMIN_PASSWORD:-admin}
      - SUITECRM_LOG_LEVEL=${SUITECRM_LOG_LEVEL:-debug}
      - SUITECRM_INSTALLER_LOCKED=${SUITECRM_INSTALLER_LOCKED:-false}
      # General
      - TZ=${TZ:-UTC}
      - SKIP_DB_WAIT=${SKIP_DB_WAIT:-false}
    volumes:
      # Azure Files mounted locally via SMB
      # These paths are created by: sudo ./scripts/azure-mount.sh
      - ${AZURE_FILES_MOUNT_BASE:-/mnt/azure/suitecrm}/upload:/var/www/html/public/legacy/upload
      - ${AZURE_FILES_MOUNT_BASE:-/mnt/azure/suitecrm}/custom:/var/www/html/public/legacy/custom
      - ${AZURE_FILES_MOUNT_BASE:-/mnt/azure/suitecrm}/cache:/var/www/html/public/legacy/cache
    networks:
      - suitecrm-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  suitecrm-network:
    driver: bridge
